<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src="d3/d3.v5.js"></script>
  </head>
  <body>
    <script type="text/javascript">
        d3.select("head").append("title").text("Renewable energy");
        d3.select("body").append("h1").text("Renewable energy");
        d3.select("body").append("p").text("Bar chart made by Leo Schreuders for the course Data Processing at the University of Amsterdam");
        d3.select("body").append("p").text("student ID 5742978");
        d3.select("body").append("p").text("The bar chart shows the amount of renewable energy a country produces in a given year. It is measured in kilo tonne of oil equivalent (ktoe).");
        d3.select("body").append("a").text("Data source").style("color","#FF0000").attr("href", "https://data.oecd.org/energy/renewable-energy.htm");


        // The drop down list for the years.
        d3.select("body").append("select").attr("id", "year");
        var w = 800;
        var h = 400;
        var barPadding = 1;

        var svg = d3.select("body")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h);


        var tooltip = d3.select("body").append("div").attr("class", "toolTip");
        tooltip
            .style("position", "absolute")
            .style("display", "none")
            .style("min-width", "80px")
            .style("height", "auto")
            .style("background", "none repeat scroll 0 0 #aaaaaa")
            .style("border", "1px solid #6F257F")
            .style("padding", "14px")
            .style("text-align", "center");


        d3.json("data.json").then(d => chart(d));






        function chart(data)  {
            // This is the function that draws the actual bar chart.
            // Based on: https://bl.ocks.org/LemoNode/73dbb9d6a144476565386f48a2df2e3b


            var countries = [...new Set(data.map(d => d.LOCATION))];
            var years  = [...new Set(data.map(d => d.TIME))];

            var options = d3.select("#year").selectAll("option")
        		.data(years)
        	    .enter().append("option")
        		.text(d => d);


            var margin = {left: 50, right: 20, top: 20, bottom: 40};



            width = w - margin.left - margin.right;
            height = h - margin.top - margin.bottom;
            console.log(data);



            var barWidth = width / countries.length - barPadding;



            var y = d3.scaleLinear();
            y.range([height, 0]);

            var yAxis = g => g
        		.attr("transform", "translate(" + (margin.left - 4) + "," + margin.top + ")")
        		.call(d3.axisLeft(y))

            svg.append("g")
                .attr("class", "y-axis")


            var x = d3.scaleBand()
            	.domain(countries)
            	.range([0, width])
            	.padding(0.01);


                // Add the x Axis
            svg.append("g")

                .attr("transform", "translate(" + margin.left + "," + (margin.top + height + 4) + ")")
                .call(d3.axisBottom(x).tickSizeOuter(0))
                .selectAll("text")
                .attr("class", "xLabel")
                .style("text-anchor", "end")
                .attr("dx", "-1em")
                .attr("dy", - barWidth / 4 + "px")
                .attr("transform", "rotate(-90)");



            update(d3.select("#year").property("value") ,0)



            function update(year, speed) {
                // This function updates the bar chart.
                var yearData = data.filter(d => d.TIME == year)

                var maxValue = d3.max(yearData, d => d.Value)


                y.domain([0, maxValue]);

                svg.selectAll(".y-axis").transition().duration(speed)
        			.call(yAxis);

                var bar = svg.selectAll(".bar").data(yearData)

                bar.exit().remove();

                bar.enter().append("rect")
                .attr("class", "bar")
                .attr("fill","orange")
                .attr("width", barWidth)
                .merge(bar)
                .transition().duration(speed)
                .attr("height", function(d) {
                        if (d.Value == null) {
                            return height - y(0);
                        };
                        return height - y(d.Value);
                      })
                .attr("x", function(d, i) {
                        return i * (width / yearData.length) + margin.left;
                      })
                .attr("y", function(d) {
                        if (d.Value == null) {
                            return margin.top + y(0);
                        };
                        return margin.top + y(d.Value); //Height minus data value
                    });

                tooltipLoad(year);

            };





            chart.update = update;



            function tooltipLoad(year) {
                var yearData = data.filter(d => d.TIME == year)
                var bar = svg.selectAll(".bar").data(yearData)
                bar.on("mousemove", function(d){
                        tooltip
                          .style("left", (d3.event.pageX - 50) + "px")
                          .style("top", (d3.event.pageY - 100) + "px")
                          .style("display", "inline-block")
                          .html(d.LOCATION + "<br>" + "Renewable energy:" + "<br>" + (d.Value) + " ktoe");
                    })
                .on("mouseout", function(d){ tooltip.style("display", "none");});


                var label = svg.selectAll(".xLabel").data(yearData)
                label.on("mousemove", function(d){
                        tooltip
                          .style("left", (d3.event.pageX - 50) + "px")
                          .style("top", (d3.event.pageY - 100) + "px")
                          .style("display", "inline-block");
                              if (d.Value == null) {
                                  tooltip.html(d.LOCATION + "<br>" + "No data");
                              } else {
                                  tooltip.html(d.LOCATION + "<br>" + "Renewable energy:" + "<br>" + (d.Value) + " ktoe");
                              };

                          })
                .on("mouseout", function(d){ tooltip.style("display", "none");});

            };
        }

        // This calls the update function of the bar chart whenever a new year is selected.
        var select = d3.select("#year")
        	.style("border-radius", "5px")
        	.on("change", function() {
        		chart.update(this.value, 750)
        	})

    </script>

  </body>
</html>

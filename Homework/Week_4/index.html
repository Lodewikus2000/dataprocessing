<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src="d3/d3.v5.js"></script>
  </head>
  <body>
    <script type="text/javascript">
        d3.select("head").append("title").text("Renewable energy!");
        d3.select("body").append("h1").text("Renewable energy!");
        d3.select("body").append("p").text("Leo Schreuders");
        d3.select("body").append("p").text("student ID 5742978");
        d3.select("body").append("p").text("This is a beautiful dataset that I don't know what it is about :(").style("color","#FF0000");
        d3.select("body").append("p").text("source: https://data.oecd.org/energy/renewable-energy.htm").style("color","#FF0000");
        d3.select("body").append("select").attr("id", "year");
        var w = 800;
        var h = 400;
        var barPadding = 1;

        var svg = d3.select("body")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h);


        var tooltip = d3.select("body").append("div").attr("class", "toolTip");

        tooltip
            .style("position", "absolute")
            .style("display", "none")
            .style("min-width", "80px")
            .style("height", "auto")
            .style("background", "none repeat scroll 0 0 #ffffff")
            .style("border", "1px solid #6F257F")
            .style("padding", "14px")
            .style("text-align", "center");


        d3.json("data.json").then(d => chart(d));


        function chart(data)  {

// mostly from here: https://bl.ocks.org/LemoNode/73dbb9d6a144476565386f48a2df2e3b
            var countries = [...new Set(data.map(d => d.LOCATION))];
            var years  = [...new Set(data.map(d => d.TIME))];
            console.log(years);
            console.log(countries);

            var options = d3.select("#year").selectAll("option")
        		.data(years)
        	    .enter().append("option")
        		.text(d => d);


            var margin = {left: 50, right: 20, top: 20, bottom: 40};



            width = w - margin.left - margin.right;
            height = h - margin.top - margin.bottom;
            console.log(data);

            // var maxValue = -1;
            // for (var d in Object.values(data)) {
            //     if (data[d].Value > maxValue) {
            //         maxValue = data[d].Value;
            //     }
            // };
            // console.log(maxValue);



            var barWidth = width / countries.length - barPadding;



            var y = d3.scaleLinear();
            y.range([height, 0]);

            var yAxis = g => g
        		.attr("transform", "translate(" + (margin.left - 4) + "," + margin.top + ")")
        		.call(d3.axisLeft(y))

            svg.append("g")
                .attr("class", "y-axis")


            var x = d3.scaleBand()
            	.domain(countries)
            	.range([0, width])
            	.padding(0.01);


                // Add the x Axis
            svg.append("g")

                .attr("transform", "translate(" + margin.left + "," + (margin.top + height + 4) + ")")
                .call(d3.axisBottom(x).tickSizeOuter(0))
                .selectAll("text")
                .style("text-anchor", "end")
                .attr("dx", "-1em")
                .attr("dy", - barWidth / 4 + "px")
                .attr("transform", "rotate(-90)");



            update(d3.select("#year").property("value") ,0)
            // I don't know why, but my tooltip doesn't work the very first time the graph loads.
            update(d3.select("#year").property("value") ,0)

            // in this function we update and draw the graph
            function update(year, speed) {
                // hier filteren we op het juiste jaar
                var yearData = data.filter(d => d.TIME == year)

                console.log(yearData);
                var maxValue = d3.max(yearData, d => d.Value)


                y.domain([0, maxValue]).nice();

                svg.selectAll(".y-axis").transition().duration(speed)
        			.call(yAxis);




                var bar = svg.selectAll(".bar").data(yearData)

                bar.exit().remove();

                bar.enter().append("rect")
                .attr("class", "bar")
                .attr("fill","orange")
                .attr("width", barWidth)
                .merge(bar)
                .transition().duration(speed)
                .attr("height", function(d) {
                        return height - y(d.Value);
                      })
                .attr("x", function(d, i) {
                        return i * (width / yearData.length) + margin.left;
                      })
                .attr("y", function(d) {
                        return margin.top + y(d.Value); //Height minus data value
                    });

                bar.on("mousemove", function(d){
                        tooltip
                          .style("left", (d3.event.pageX - 50) + "px")
                          .style("top", (d3.event.pageY - 100) + "px")
                          .style("display", "inline-block")
                          .html(d.LOCATION + "<br>" + "Renewable energy:" + "<br>" + (d.Value) + " ktoe");
                    })
                .on("mouseout", function(d){ tooltip.style("display", "none");});
            };

            chart.update = update;
        }

        var select = d3.select("#year")
        	.style("border-radius", "5px")
        	.on("change", function() {
        		chart.update(this.value, 750)
        	})

              console.log(svg.selectAll("text"))


                 // I think we don't do this anymore?
            // var labels = svg.selectAll(".test").data(data).enter().append("text").attr('class', 'test');
            // labels.text(function(d) {
            //           return Math.round(d.Value / 1000);
            //         })
            //         .attr("x", function(d, i) {
            //           return i * (width / data.length) + margin.left;
            //         })
            //         .attr("y", function(d) {
            //           return margin.top + scale(d.Value); //Height minus data value
            //       });





    </script>

  </body>
</html>
